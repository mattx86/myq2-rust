// m_supertank.rs — Supertank (Boss1) monster
// Converted from: myq2-original/game/m_supertank.c
// Frame definitions from: myq2-original/game/m_supertank.h

use crate::g_local::*;
use crate::game::*;
use myq2_common::common::{frand as random, rand_i32};
use crate::entity_adapters::{
    gi_sound, gi_soundindex, gi_modelindex, gi_linkentity,
    g_free_edict, walkmonster_start, throw_gib, throw_head,
    visible, monster_flash_offset, g_project_source,
    monster_fire_rocket, monster_fire_bullet,
};

// ============================================================
// Frame definitions (from m_supertank.h)
// This file generated by ModelGen - Do NOT Modify
// ============================================================

pub const FRAME_ATTAK1_1: i32 = 0;
pub const FRAME_ATTAK1_2: i32 = 1;
pub const FRAME_ATTAK1_3: i32 = 2;
pub const FRAME_ATTAK1_4: i32 = 3;
pub const FRAME_ATTAK1_5: i32 = 4;
pub const FRAME_ATTAK1_6: i32 = 5;
pub const FRAME_ATTAK1_7: i32 = 6;
pub const FRAME_ATTAK1_8: i32 = 7;
pub const FRAME_ATTAK1_9: i32 = 8;
pub const FRAME_ATTAK1_10: i32 = 9;
pub const FRAME_ATTAK1_11: i32 = 10;
pub const FRAME_ATTAK1_12: i32 = 11;
pub const FRAME_ATTAK1_13: i32 = 12;
pub const FRAME_ATTAK1_14: i32 = 13;
pub const FRAME_ATTAK1_15: i32 = 14;
pub const FRAME_ATTAK1_16: i32 = 15;
pub const FRAME_ATTAK1_17: i32 = 16;
pub const FRAME_ATTAK1_18: i32 = 17;
pub const FRAME_ATTAK1_19: i32 = 18;
pub const FRAME_ATTAK1_20: i32 = 19;
pub const FRAME_ATTAK2_1: i32 = 20;
pub const FRAME_ATTAK2_2: i32 = 21;
pub const FRAME_ATTAK2_3: i32 = 22;
pub const FRAME_ATTAK2_4: i32 = 23;
pub const FRAME_ATTAK2_5: i32 = 24;
pub const FRAME_ATTAK2_6: i32 = 25;
pub const FRAME_ATTAK2_7: i32 = 26;
pub const FRAME_ATTAK2_8: i32 = 27;
pub const FRAME_ATTAK2_9: i32 = 28;
pub const FRAME_ATTAK2_10: i32 = 29;
pub const FRAME_ATTAK2_11: i32 = 30;
pub const FRAME_ATTAK2_12: i32 = 31;
pub const FRAME_ATTAK2_13: i32 = 32;
pub const FRAME_ATTAK2_14: i32 = 33;
pub const FRAME_ATTAK2_15: i32 = 34;
pub const FRAME_ATTAK2_16: i32 = 35;
pub const FRAME_ATTAK2_17: i32 = 36;
pub const FRAME_ATTAK2_18: i32 = 37;
pub const FRAME_ATTAK2_19: i32 = 38;
pub const FRAME_ATTAK2_20: i32 = 39;
pub const FRAME_ATTAK2_21: i32 = 40;
pub const FRAME_ATTAK2_22: i32 = 41;
pub const FRAME_ATTAK2_23: i32 = 42;
pub const FRAME_ATTAK2_24: i32 = 43;
pub const FRAME_ATTAK2_25: i32 = 44;
pub const FRAME_ATTAK2_26: i32 = 45;
pub const FRAME_ATTAK2_27: i32 = 46;
pub const FRAME_ATTAK3_1: i32 = 47;
pub const FRAME_ATTAK3_2: i32 = 48;
pub const FRAME_ATTAK3_3: i32 = 49;
pub const FRAME_ATTAK3_4: i32 = 50;
pub const FRAME_ATTAK3_5: i32 = 51;
pub const FRAME_ATTAK3_6: i32 = 52;
pub const FRAME_ATTAK3_7: i32 = 53;
pub const FRAME_ATTAK3_8: i32 = 54;
pub const FRAME_ATTAK3_9: i32 = 55;
pub const FRAME_ATTAK3_10: i32 = 56;
pub const FRAME_ATTAK3_11: i32 = 57;
pub const FRAME_ATTAK3_12: i32 = 58;
pub const FRAME_ATTAK3_13: i32 = 59;
pub const FRAME_ATTAK3_14: i32 = 60;
pub const FRAME_ATTAK3_15: i32 = 61;
pub const FRAME_ATTAK3_16: i32 = 62;
pub const FRAME_ATTAK3_17: i32 = 63;
pub const FRAME_ATTAK3_18: i32 = 64;
pub const FRAME_ATTAK3_19: i32 = 65;
pub const FRAME_ATTAK3_20: i32 = 66;
pub const FRAME_ATTAK3_21: i32 = 67;
pub const FRAME_ATTAK3_22: i32 = 68;
pub const FRAME_ATTAK3_23: i32 = 69;
pub const FRAME_ATTAK3_24: i32 = 70;
pub const FRAME_ATTAK3_25: i32 = 71;
pub const FRAME_ATTAK3_26: i32 = 72;
pub const FRAME_ATTAK3_27: i32 = 73;
pub const FRAME_ATTAK4_1: i32 = 74;
pub const FRAME_ATTAK4_2: i32 = 75;
pub const FRAME_ATTAK4_3: i32 = 76;
pub const FRAME_ATTAK4_4: i32 = 77;
pub const FRAME_ATTAK4_5: i32 = 78;
pub const FRAME_ATTAK4_6: i32 = 79;
pub const FRAME_BACKWD_1: i32 = 80;
pub const FRAME_BACKWD_2: i32 = 81;
pub const FRAME_BACKWD_3: i32 = 82;
pub const FRAME_BACKWD_4: i32 = 83;
pub const FRAME_BACKWD_5: i32 = 84;
pub const FRAME_BACKWD_6: i32 = 85;
pub const FRAME_BACKWD_7: i32 = 86;
pub const FRAME_BACKWD_8: i32 = 87;
pub const FRAME_BACKWD_9: i32 = 88;
pub const FRAME_BACKWD_10: i32 = 89;
pub const FRAME_BACKWD_11: i32 = 90;
pub const FRAME_BACKWD_12: i32 = 91;
pub const FRAME_BACKWD_13: i32 = 92;
pub const FRAME_BACKWD_14: i32 = 93;
pub const FRAME_BACKWD_15: i32 = 94;
pub const FRAME_BACKWD_16: i32 = 95;
pub const FRAME_BACKWD_17: i32 = 96;
pub const FRAME_BACKWD_18: i32 = 97;
pub const FRAME_DEATH_1: i32 = 98;
pub const FRAME_DEATH_2: i32 = 99;
pub const FRAME_DEATH_3: i32 = 100;
pub const FRAME_DEATH_4: i32 = 101;
pub const FRAME_DEATH_5: i32 = 102;
pub const FRAME_DEATH_6: i32 = 103;
pub const FRAME_DEATH_7: i32 = 104;
pub const FRAME_DEATH_8: i32 = 105;
pub const FRAME_DEATH_9: i32 = 106;
pub const FRAME_DEATH_10: i32 = 107;
pub const FRAME_DEATH_11: i32 = 108;
pub const FRAME_DEATH_12: i32 = 109;
pub const FRAME_DEATH_13: i32 = 110;
pub const FRAME_DEATH_14: i32 = 111;
pub const FRAME_DEATH_15: i32 = 112;
pub const FRAME_DEATH_16: i32 = 113;
pub const FRAME_DEATH_17: i32 = 114;
pub const FRAME_DEATH_18: i32 = 115;
pub const FRAME_DEATH_19: i32 = 116;
pub const FRAME_DEATH_20: i32 = 117;
pub const FRAME_DEATH_21: i32 = 118;
pub const FRAME_DEATH_22: i32 = 119;
pub const FRAME_DEATH_23: i32 = 120;
pub const FRAME_DEATH_24: i32 = 121;
pub const FRAME_DEATH_31: i32 = 122;
pub const FRAME_DEATH_32: i32 = 123;
pub const FRAME_DEATH_33: i32 = 124;
pub const FRAME_DEATH_45: i32 = 125;
pub const FRAME_DEATH_46: i32 = 126;
pub const FRAME_DEATH_47: i32 = 127;
pub const FRAME_FORWRD_1: i32 = 128;
pub const FRAME_FORWRD_2: i32 = 129;
pub const FRAME_FORWRD_3: i32 = 130;
pub const FRAME_FORWRD_4: i32 = 131;
pub const FRAME_FORWRD_5: i32 = 132;
pub const FRAME_FORWRD_6: i32 = 133;
pub const FRAME_FORWRD_7: i32 = 134;
pub const FRAME_FORWRD_8: i32 = 135;
pub const FRAME_FORWRD_9: i32 = 136;
pub const FRAME_FORWRD_10: i32 = 137;
pub const FRAME_FORWRD_11: i32 = 138;
pub const FRAME_FORWRD_12: i32 = 139;
pub const FRAME_FORWRD_13: i32 = 140;
pub const FRAME_FORWRD_14: i32 = 141;
pub const FRAME_FORWRD_15: i32 = 142;
pub const FRAME_FORWRD_16: i32 = 143;
pub const FRAME_FORWRD_17: i32 = 144;
pub const FRAME_FORWRD_18: i32 = 145;
pub const FRAME_LEFT_1: i32 = 146;
pub const FRAME_LEFT_2: i32 = 147;
pub const FRAME_LEFT_3: i32 = 148;
pub const FRAME_LEFT_4: i32 = 149;
pub const FRAME_LEFT_5: i32 = 150;
pub const FRAME_LEFT_6: i32 = 151;
pub const FRAME_LEFT_7: i32 = 152;
pub const FRAME_LEFT_8: i32 = 153;
pub const FRAME_LEFT_9: i32 = 154;
pub const FRAME_LEFT_10: i32 = 155;
pub const FRAME_LEFT_11: i32 = 156;
pub const FRAME_LEFT_12: i32 = 157;
pub const FRAME_LEFT_13: i32 = 158;
pub const FRAME_LEFT_14: i32 = 159;
pub const FRAME_LEFT_15: i32 = 160;
pub const FRAME_LEFT_16: i32 = 161;
pub const FRAME_LEFT_17: i32 = 162;
pub const FRAME_LEFT_18: i32 = 163;
pub const FRAME_PAIN1_1: i32 = 164;
pub const FRAME_PAIN1_2: i32 = 165;
pub const FRAME_PAIN1_3: i32 = 166;
pub const FRAME_PAIN1_4: i32 = 167;
pub const FRAME_PAIN2_5: i32 = 168;
pub const FRAME_PAIN2_6: i32 = 169;
pub const FRAME_PAIN2_7: i32 = 170;
pub const FRAME_PAIN2_8: i32 = 171;
pub const FRAME_PAIN3_9: i32 = 172;
pub const FRAME_PAIN3_10: i32 = 173;
pub const FRAME_PAIN3_11: i32 = 174;
pub const FRAME_PAIN3_12: i32 = 175;
pub const FRAME_RIGHT_1: i32 = 176;
pub const FRAME_RIGHT_2: i32 = 177;
pub const FRAME_RIGHT_3: i32 = 178;
pub const FRAME_RIGHT_4: i32 = 179;
pub const FRAME_RIGHT_5: i32 = 180;
pub const FRAME_RIGHT_6: i32 = 181;
pub const FRAME_RIGHT_7: i32 = 182;
pub const FRAME_RIGHT_8: i32 = 183;
pub const FRAME_RIGHT_9: i32 = 184;
pub const FRAME_RIGHT_10: i32 = 185;
pub const FRAME_RIGHT_11: i32 = 186;
pub const FRAME_RIGHT_12: i32 = 187;
pub const FRAME_RIGHT_13: i32 = 188;
pub const FRAME_RIGHT_14: i32 = 189;
pub const FRAME_RIGHT_15: i32 = 190;
pub const FRAME_RIGHT_16: i32 = 191;
pub const FRAME_RIGHT_17: i32 = 192;
pub const FRAME_RIGHT_18: i32 = 193;
pub const FRAME_STAND_1: i32 = 194;
pub const FRAME_STAND_2: i32 = 195;
pub const FRAME_STAND_3: i32 = 196;
pub const FRAME_STAND_4: i32 = 197;
pub const FRAME_STAND_5: i32 = 198;
pub const FRAME_STAND_6: i32 = 199;
pub const FRAME_STAND_7: i32 = 200;
pub const FRAME_STAND_8: i32 = 201;
pub const FRAME_STAND_9: i32 = 202;
pub const FRAME_STAND_10: i32 = 203;
pub const FRAME_STAND_11: i32 = 204;
pub const FRAME_STAND_12: i32 = 205;
pub const FRAME_STAND_13: i32 = 206;
pub const FRAME_STAND_14: i32 = 207;
pub const FRAME_STAND_15: i32 = 208;
pub const FRAME_STAND_16: i32 = 209;
pub const FRAME_STAND_17: i32 = 210;
pub const FRAME_STAND_18: i32 = 211;
pub const FRAME_STAND_19: i32 = 212;
pub const FRAME_STAND_20: i32 = 213;
pub const FRAME_STAND_21: i32 = 214;
pub const FRAME_STAND_22: i32 = 215;
pub const FRAME_STAND_23: i32 = 216;
pub const FRAME_STAND_24: i32 = 217;
pub const FRAME_STAND_25: i32 = 218;
pub const FRAME_STAND_26: i32 = 219;
pub const FRAME_STAND_27: i32 = 220;
pub const FRAME_STAND_28: i32 = 221;
pub const FRAME_STAND_29: i32 = 222;
pub const FRAME_STAND_30: i32 = 223;
pub const FRAME_STAND_31: i32 = 224;
pub const FRAME_STAND_32: i32 = 225;
pub const FRAME_STAND_33: i32 = 226;
pub const FRAME_STAND_34: i32 = 227;
pub const FRAME_STAND_35: i32 = 228;
pub const FRAME_STAND_36: i32 = 229;
pub const FRAME_STAND_37: i32 = 230;
pub const FRAME_STAND_38: i32 = 231;
pub const FRAME_STAND_39: i32 = 232;
pub const FRAME_STAND_40: i32 = 233;
pub const FRAME_STAND_41: i32 = 234;
pub const FRAME_STAND_42: i32 = 235;
pub const FRAME_STAND_43: i32 = 236;
pub const FRAME_STAND_44: i32 = 237;
pub const FRAME_STAND_45: i32 = 238;
pub const FRAME_STAND_46: i32 = 239;
pub const FRAME_STAND_47: i32 = 240;
pub const FRAME_STAND_48: i32 = 241;
pub const FRAME_STAND_49: i32 = 242;
pub const FRAME_STAND_50: i32 = 243;
pub const FRAME_STAND_51: i32 = 244;
pub const FRAME_STAND_52: i32 = 245;
pub const FRAME_STAND_53: i32 = 246;
pub const FRAME_STAND_54: i32 = 247;
pub const FRAME_STAND_55: i32 = 248;
pub const FRAME_STAND_56: i32 = 249;
pub const FRAME_STAND_57: i32 = 250;
pub const FRAME_STAND_58: i32 = 251;
pub const FRAME_STAND_59: i32 = 252;
pub const FRAME_STAND_60: i32 = 253;

pub const MODEL_SCALE: f32 = 1.0;

// ============================================================
// Sound channel / attenuation / muzzle flash constants
// ============================================================

// CHAN_*, ATTN_* come from g_local::* re-export (myq2_common::q_shared)

const MZ2_SUPERTANK_MACHINEGUN_1: i32 = 72;
const MZ2_SUPERTANK_MACHINEGUN_2: i32 = 73;
const MZ2_SUPERTANK_MACHINEGUN_3: i32 = 74;
const MZ2_SUPERTANK_MACHINEGUN_4: i32 = 75;
const MZ2_SUPERTANK_MACHINEGUN_5: i32 = 76;
const MZ2_SUPERTANK_MACHINEGUN_6: i32 = 77;
const MZ2_SUPERTANK_ROCKET_1: i32 = 78;
const MZ2_SUPERTANK_ROCKET_2: i32 = 79;
const MZ2_SUPERTANK_ROCKET_3: i32 = 80;

use crate::g_local::TE_EXPLOSION1;


use crate::ai_wrappers::{ai_stand, ai_walk, ai_run, ai_charge, ai_move};

// ============================================================
// Sound indices (module-level state, replaces C statics)
// ============================================================

#[derive(Default)]
pub struct SupertankSounds {
    pub pain1: i32,
    pub pain2: i32,
    pub pain3: i32,
    pub death: i32,
    pub search1: i32,
    pub search2: i32,
    pub tread: i32,
}

static SOUNDS: std::sync::OnceLock<SupertankSounds> = std::sync::OnceLock::new();

use crate::game_import::{gi_write_byte, gi_write_position, gi_multicast};

use myq2_common::q_shared::angle_vectors;


use myq2_common::q_shared::{
    vector_subtract as vec_subtract, vector_length as vec_length,
    vector_normalize as vec_normalize,
};
// MULTICAST_PVS comes from g_local::* (value = 2)

// ============================================================
// Move index constants
// ============================================================

pub const MOVE_STAND: usize = 0;
pub const MOVE_RUN: usize = 1;
pub const MOVE_FORWARD: usize = 2;
pub const MOVE_TURN_RIGHT: usize = 3;
pub const MOVE_TURN_LEFT: usize = 4;
pub const MOVE_PAIN1: usize = 5;
pub const MOVE_PAIN2: usize = 6;
pub const MOVE_PAIN3: usize = 7;
pub const MOVE_DEATH: usize = 8;
pub const MOVE_BACKWARD: usize = 9;
pub const MOVE_ATTACK1: usize = 10;
pub const MOVE_ATTACK2: usize = 11;
pub const MOVE_ATTACK3: usize = 12;
pub const MOVE_ATTACK4: usize = 13;
pub const MOVE_END_ATTACK1: usize = 14;

// ============================================================
// Behavior functions
// ============================================================

fn tread_sound(self_ent: &mut Edict, _ctx: &mut GameContext) {
    let sound = SOUNDS.get().map_or(0, |s| s.tread);
    gi_sound(self_ent, CHAN_VOICE, sound, 1.0, ATTN_NORM, 0.0);
}

pub fn supertank_search(self_ent: &mut Edict, _ctx: &mut GameContext) {
    if random() < 0.5 {
        let s = SOUNDS.get().map_or(0, |s| s.search1);
        gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
    } else {
        let s = SOUNDS.get().map_or(0, |s| s.search2);
        gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
    }
}

// ============================================================
// Stand animation (60 frames)
// ============================================================

static SUPERTANK_FRAMES_STAND: [MFrame; 60] = [
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_STAND: MMove = MMove {
    firstframe: FRAME_STAND_1,
    lastframe: FRAME_STAND_60,
    frames: &SUPERTANK_FRAMES_STAND,
    endfunc: None,
};

pub fn supertank_stand(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.monsterinfo.currentmove = Some(MOVE_STAND);
}

// ============================================================
// Run animation (18 frames)
// ============================================================

static SUPERTANK_FRAMES_RUN: [MFrame; 18] = [
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: Some(tread_sound) },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 12.0, think_fn: None },
];

pub static SUPERTANK_MOVE_RUN: MMove = MMove {
    firstframe: FRAME_FORWRD_1,
    lastframe: FRAME_FORWRD_18,
    frames: &SUPERTANK_FRAMES_RUN,
    endfunc: None,
};

// ============================================================
// Walk / Forward animation (18 frames)
// ============================================================

static SUPERTANK_FRAMES_FORWARD: [MFrame; 18] = [
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: Some(tread_sound) },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 4.0, think_fn: None },
];

pub static SUPERTANK_MOVE_FORWARD: MMove = MMove {
    firstframe: FRAME_FORWRD_1,
    lastframe: FRAME_FORWRD_18,
    frames: &SUPERTANK_FRAMES_FORWARD,
    endfunc: None,
};

pub fn supertank_forward(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.monsterinfo.currentmove = Some(MOVE_FORWARD);
}

pub fn supertank_walk(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.monsterinfo.currentmove = Some(MOVE_FORWARD);
}

pub fn supertank_run(self_ent: &mut Edict, _ctx: &mut GameContext) {
    if self_ent.monsterinfo.aiflags.intersects(AI_STAND_GROUND) {
        self_ent.monsterinfo.currentmove = Some(MOVE_STAND);
    } else {
        self_ent.monsterinfo.currentmove = Some(MOVE_RUN);
    }
}

// ============================================================
// Turn right animation (18 frames)
// ============================================================

static SUPERTANK_FRAMES_TURN_RIGHT: [MFrame; 18] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: Some(tread_sound) },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_TURN_RIGHT: MMove = MMove {
    firstframe: FRAME_RIGHT_1,
    lastframe: FRAME_RIGHT_18,
    frames: &SUPERTANK_FRAMES_TURN_RIGHT,
    endfunc: Some(supertank_run),
};

// ============================================================
// Turn left animation (18 frames)
// ============================================================

static SUPERTANK_FRAMES_TURN_LEFT: [MFrame; 18] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: Some(tread_sound) },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_TURN_LEFT: MMove = MMove {
    firstframe: FRAME_LEFT_1,
    lastframe: FRAME_LEFT_18,
    frames: &SUPERTANK_FRAMES_TURN_LEFT,
    endfunc: Some(supertank_run),
};

// ============================================================
// Pain animations
// ============================================================

static SUPERTANK_FRAMES_PAIN3: [MFrame; 4] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_PAIN3: MMove = MMove {
    firstframe: FRAME_PAIN3_9,
    lastframe: FRAME_PAIN3_12,
    frames: &SUPERTANK_FRAMES_PAIN3,
    endfunc: Some(supertank_run),
};

static SUPERTANK_FRAMES_PAIN2: [MFrame; 4] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_PAIN2: MMove = MMove {
    firstframe: FRAME_PAIN2_5,
    lastframe: FRAME_PAIN2_8,
    frames: &SUPERTANK_FRAMES_PAIN2,
    endfunc: Some(supertank_run),
};

static SUPERTANK_FRAMES_PAIN1: [MFrame; 4] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_PAIN1: MMove = MMove {
    firstframe: FRAME_PAIN1_1,
    lastframe: FRAME_PAIN1_4,
    frames: &SUPERTANK_FRAMES_PAIN1,
    endfunc: Some(supertank_run),
};

// ============================================================
// Death animation (24 frames)
// ============================================================

static SUPERTANK_FRAMES_DEATH1: [MFrame; 24] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: Some(boss_explode) },
];

pub static SUPERTANK_MOVE_DEATH: MMove = MMove {
    firstframe: FRAME_DEATH_1,
    lastframe: FRAME_DEATH_24,
    frames: &SUPERTANK_FRAMES_DEATH1,
    endfunc: Some(supertank_dead),
};

// ============================================================
// Backward animation (18 frames)
// ============================================================

static SUPERTANK_FRAMES_BACKWARD: [MFrame; 18] = [
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: Some(tread_sound) },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_BACKWARD: MMove = MMove {
    firstframe: FRAME_BACKWD_1,
    lastframe: FRAME_BACKWD_18,
    frames: &SUPERTANK_FRAMES_BACKWARD,
    endfunc: None,
};

// ============================================================
// Attack 4 animation (6 frames)
// ============================================================

static SUPERTANK_FRAMES_ATTACK4: [MFrame; 6] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_ATTACK4: MMove = MMove {
    firstframe: FRAME_ATTAK4_1,
    lastframe: FRAME_ATTAK4_6,
    frames: &SUPERTANK_FRAMES_ATTACK4,
    endfunc: Some(supertank_run),
};

// ============================================================
// Attack 3 animation (27 frames)
// ============================================================

static SUPERTANK_FRAMES_ATTACK3: [MFrame; 27] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_ATTACK3: MMove = MMove {
    firstframe: FRAME_ATTAK3_1,
    lastframe: FRAME_ATTAK3_27,
    frames: &SUPERTANK_FRAMES_ATTACK3,
    endfunc: Some(supertank_run),
};

// ============================================================
// Attack 2 — Rocket Launcher (27 frames)
// ============================================================

static SUPERTANK_FRAMES_ATTACK2: [MFrame; 27] = [
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_rocket) },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: Some(supertank_rocket) },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: Some(supertank_rocket) },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_ATTACK2: MMove = MMove {
    firstframe: FRAME_ATTAK2_1,
    lastframe: FRAME_ATTAK2_27,
    frames: &SUPERTANK_FRAMES_ATTACK2,
    endfunc: Some(supertank_run),
};

// ============================================================
// Attack 1 — Chaingun (6 frames)
// ============================================================

static SUPERTANK_FRAMES_ATTACK1: [MFrame; 6] = [
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(supertank_machinegun) },
];

pub static SUPERTANK_MOVE_ATTACK1: MMove = MMove {
    firstframe: FRAME_ATTAK1_1,
    lastframe: FRAME_ATTAK1_6,
    frames: &SUPERTANK_FRAMES_ATTACK1,
    endfunc: Some(supertank_reattack1),
};

// ============================================================
// End Attack 1 (14 frames)
// ============================================================

static SUPERTANK_FRAMES_END_ATTACK1: [MFrame; 14] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static SUPERTANK_MOVE_END_ATTACK1: MMove = MMove {
    firstframe: FRAME_ATTAK1_7,
    lastframe: FRAME_ATTAK1_20,
    frames: &SUPERTANK_FRAMES_END_ATTACK1,
    endfunc: Some(supertank_run),
};

// ============================================================
// Reattack1 — decides whether to continue chaingun or stop
// ============================================================

pub fn supertank_reattack1(self_ent: &mut Edict, _ctx: &mut GameContext) {
    let enemy_idx = self_ent.enemy;
    let enemy_visible = if enemy_idx > 0 && (enemy_idx as usize) < _ctx.edicts.len() {
        visible(self_ent, &_ctx.edicts[enemy_idx as usize])
    } else {
        false
    };
    if enemy_visible {
        if random() < 0.9 {
            self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK1);
        } else {
            self_ent.monsterinfo.currentmove = Some(MOVE_END_ATTACK1);
        }
    } else {
        self_ent.monsterinfo.currentmove = Some(MOVE_END_ATTACK1);
    }
}

// ============================================================
// Pain
// ============================================================

pub fn supertank_pain(self_ent: &mut Edict, _other: &mut Edict, _kick: f32, damage: i32, ctx: &mut GameContext) {
    if self_ent.health < (self_ent.max_health / 2) {
        self_ent.s.skinnum = 1;
    }

    if ctx.level.time < self_ent.pain_debounce_time {
        return;
    }

    // Lessen the chance of him going into his pain frames
    if damage <= 25
        && random() < 0.2 {
            return;
        }

    // Don't go into pain if he's firing his rockets
    let skill_value: f32 = crate::game_import::gi_cvar("skill", "1", 0);
    if skill_value >= 2.0
        && self_ent.s.frame >= FRAME_ATTAK2_1 && self_ent.s.frame <= FRAME_ATTAK2_14 {
            return;
        }

    self_ent.pain_debounce_time = ctx.level.time + 3.0;

    if skill_value == 3.0 {
        return; // no pain anims in nightmare
    }

    if damage <= 10 {
        let s = SOUNDS.get().map_or(0, |s| s.pain1);
        gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
        self_ent.monsterinfo.currentmove = Some(MOVE_PAIN1);
    } else if damage <= 25 {
        let s = SOUNDS.get().map_or(0, |s| s.pain3);
        gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
        self_ent.monsterinfo.currentmove = Some(MOVE_PAIN2);
    } else {
        let s = SOUNDS.get().map_or(0, |s| s.pain2);
        gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
        self_ent.monsterinfo.currentmove = Some(MOVE_PAIN3);
    }
}

// ============================================================
// Rocket attack
// ============================================================

fn supertank_rocket(self_ent: &mut Edict, ctx: &mut GameContext) {
    let mut forward = [0.0_f32; 3];
    let mut right = [0.0_f32; 3];
    let mut start = [0.0_f32; 3];
    let mut dir: [f32; 3];
    let mut vec: [f32; 3];

    let flash_number = if self_ent.s.frame == FRAME_ATTAK2_8 {
        MZ2_SUPERTANK_ROCKET_1
    } else if self_ent.s.frame == FRAME_ATTAK2_11 {
        MZ2_SUPERTANK_ROCKET_2
    } else {
        // self->s.frame == FRAME_attak2_14
        MZ2_SUPERTANK_ROCKET_3
    };

    angle_vectors(&self_ent.s.angles, Some(&mut forward), Some(&mut right), None);
    let offset = monster_flash_offset(flash_number);
    g_project_source(&self_ent.s.origin, &offset, &forward, &right, &mut start);

    let enemy_idx = self_ent.enemy;
    if enemy_idx >= 0 {
        let enemy = &ctx.edicts[enemy_idx as usize];
        vec = enemy.s.origin;
        vec[2] += enemy.viewheight as f32;
    } else {
        vec = self_ent.s.origin;
    }

    dir = vec_subtract(&vec, &start);
    vec_normalize(&mut dir);

    monster_fire_rocket(self_ent, start, dir, 50, 500, flash_number);
}

// ============================================================
// MachineGun attack
// ============================================================

fn supertank_machinegun(self_ent: &mut Edict, ctx: &mut GameContext) {
    let mut dir_angles = [0.0_f32; 3];
    let mut forward = [0.0_f32; 3];
    let mut right = [0.0_f32; 3];
    let mut start = [0.0_f32; 3];
    let mut vec: [f32; 3];

    let flash_number = MZ2_SUPERTANK_MACHINEGUN_1 + (self_ent.s.frame - FRAME_ATTAK1_1);

    // Set aim direction (pitch=0 for horizontal fire, yaw from entity facing)
    dir_angles[0] = 0.0;
    dir_angles[1] = self_ent.s.angles[1];
    dir_angles[2] = 0.0;

    angle_vectors(&dir_angles, Some(&mut forward), Some(&mut right), None);
    let offset = monster_flash_offset(flash_number);
    g_project_source(&self_ent.s.origin, &offset, &forward, &right, &mut start);

    let enemy_idx = self_ent.enemy;
    if enemy_idx >= 0 {
        let enemy = &ctx.edicts[enemy_idx as usize];
        vec = enemy.s.origin;
        // VectorMA(vec, 0, self->enemy->velocity, vec) -- multiplied by 0, no-op
        vec[2] += enemy.viewheight as f32;
        forward = vec_subtract(&vec, &start);
        vec_normalize(&mut forward);
    }

    monster_fire_bullet(self_ent, start, forward, 6, 4, DEFAULT_BULLET_HSPREAD, DEFAULT_BULLET_VSPREAD, flash_number);
}

// ============================================================
// Attack decision
// ============================================================

pub fn supertank_attack(self_ent: &mut Edict, ctx: &mut GameContext) {
    let enemy_idx = self_ent.enemy;
    let enemy_origin = if enemy_idx >= 0 {
        ctx.edicts[enemy_idx as usize].s.origin
    } else {
        self_ent.s.origin
    };
    let vec = vec_subtract(&enemy_origin, &self_ent.s.origin);
    let range = vec_length(&vec);

    // Attack 1 == Chaingun
    // Attack 2 == Rocket Launcher
    if range <= 160.0 {
        self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK1);
    } else {
        // fire rockets more often at distance
        if random() < 0.3 {
            self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK1);
        } else {
            self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK2);
        }
    }
}

// ============================================================
// Death
// ============================================================

fn supertank_dead(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.mins = [-60.0, -60.0, 0.0];
    self_ent.maxs = [60.0, 60.0, 72.0];
    self_ent.movetype = MoveType::Toss;
    self_ent.svflags |= SVF_DEADMONSTER;
    self_ent.nextthink = 0.0;
    gi_linkentity(self_ent);
}

fn boss_explode(self_ent: &mut Edict, _ctx: &mut GameContext) {
    let mut org: [f32; 3] = self_ent.s.origin;
    org[2] += 24.0 + (rand_i32() & 15) as f32;

    let count = self_ent.count;
    self_ent.count += 1;

    match count {
        0 => {
            org[0] -= 24.0;
            org[1] -= 24.0;
        }
        1 => {
            org[0] += 24.0;
            org[1] += 24.0;
        }
        2 => {
            org[0] += 24.0;
            org[1] -= 24.0;
        }
        3 => {
            org[0] -= 24.0;
            org[1] += 24.0;
        }
        4 => {
            org[0] -= 48.0;
            org[1] -= 48.0;
        }
        5 => {
            org[0] += 48.0;
            org[1] += 48.0;
        }
        6 => {
            org[0] -= 48.0;
            org[1] += 48.0;
        }
        7 => {
            org[0] += 48.0;
            org[1] -= 48.0;
        }
        8 => {
            self_ent.s.sound = 0;
            for _ in 0..4 {
                throw_gib(self_ent, "models/objects/gibs/sm_meat/tris.md2", 500, GIB_ORGANIC);
            }
            for _ in 0..8 {
                throw_gib(self_ent, "models/objects/gibs/sm_metal/tris.md2", 500, GIB_METALLIC);
            }
            throw_gib(self_ent, "models/objects/gibs/chest/tris.md2", 500, GIB_ORGANIC);
            throw_head(self_ent, "models/objects/gibs/gear/tris.md2", 500, GIB_METALLIC);
            self_ent.deadflag = DEAD_DEAD;
            return;
        }
        _ => {}
    }

    gi_write_byte(SVC_TEMP_ENTITY);
    gi_write_byte(TE_EXPLOSION1);
    gi_write_position(&org);
    gi_multicast(&self_ent.s.origin, MULTICAST_PVS);

    // self->think = BossExplode; (handled by animation system setting nextthink)
    self_ent.nextthink = _ctx.level.time + 0.1;
}

pub fn supertank_die(self_ent: &mut Edict, _inflictor: &mut Edict, _attacker: &mut Edict, _damage: i32, _point: [f32; 3], _ctx: &mut GameContext) {
    let s = SOUNDS.get().map_or(0, |s| s.death);
    gi_sound(self_ent, CHAN_VOICE, s, 1.0, ATTN_NORM, 0.0);
    self_ent.deadflag = DEAD_DEAD;
    self_ent.takedamage = Damage::No as i32;
    self_ent.count = 0;
    self_ent.monsterinfo.currentmove = Some(MOVE_DEATH);
}

// ============================================================
// Spawn function
// ============================================================

/// QUAKED monster_supertank (1 .5 0) (-64 -64 0) (64 64 72) Ambush Trigger_Spawn Sight
pub fn sp_monster_supertank(self_ent: &mut Edict, ctx: &mut GameContext) {
    if ctx.deathmatch != 0.0 {
        g_free_edict(self_ent);
        return;
    }

    SOUNDS.get_or_init(|| SupertankSounds {
        pain1: gi_soundindex("bosstank/btkpain1.wav"),
        pain2: gi_soundindex("bosstank/btkpain2.wav"),
        pain3: gi_soundindex("bosstank/btkpain3.wav"),
        death: gi_soundindex("bosstank/btkdeth1.wav"),
        search1: gi_soundindex("bosstank/btkunqv1.wav"),
        search2: gi_soundindex("bosstank/btkunqv2.wav"),
        tread: gi_soundindex("bosstank/btkengn1.wav"),
    });

    self_ent.movetype = MoveType::Step;
    self_ent.solid = Solid::Bbox;
    self_ent.s.modelindex = gi_modelindex("models/monsters/boss1/tris.md2");
    self_ent.mins = [-64.0, -64.0, 0.0];
    self_ent.maxs = [64.0, 64.0, 112.0];

    self_ent.health = 1500;
    self_ent.gib_health = -500;
    self_ent.mass = 800;

    self_ent.pain_fn = Some(crate::dispatch::PAIN_SUPERTANK);
    self_ent.die_fn = Some(crate::dispatch::DIE_SUPERTANK);

    self_ent.monsterinfo.stand_fn = Some(crate::dispatch::MSTAND_SUPERTANK);
    self_ent.monsterinfo.walk_fn = Some(crate::dispatch::MWALK_SUPERTANK);
    self_ent.monsterinfo.run_fn = Some(crate::dispatch::MRUN_SUPERTANK);
    self_ent.monsterinfo.dodge_fn = None;
    self_ent.monsterinfo.attack_fn = Some(crate::dispatch::MATTACK_SUPERTANK);
    self_ent.monsterinfo.search_fn = Some(crate::dispatch::MSEARCH_SUPERTANK);
    self_ent.monsterinfo.melee_fn = None;
    self_ent.monsterinfo.sight_fn = None;

    gi_linkentity(self_ent);

    self_ent.monsterinfo.currentmove = Some(MOVE_STAND);
    self_ent.monsterinfo.scale = MODEL_SCALE;

    walkmonster_start(self_ent);
}

// ============================================================
// Move table: maps move indices to MMove statics
// ============================================================

pub fn supertank_get_move(index: usize) -> Option<&'static MMove> {
    match index {
        MOVE_STAND => Some(&SUPERTANK_MOVE_STAND),
        MOVE_RUN => Some(&SUPERTANK_MOVE_RUN),
        MOVE_FORWARD => Some(&SUPERTANK_MOVE_FORWARD),
        MOVE_TURN_RIGHT => Some(&SUPERTANK_MOVE_TURN_RIGHT),
        MOVE_TURN_LEFT => Some(&SUPERTANK_MOVE_TURN_LEFT),
        MOVE_PAIN1 => Some(&SUPERTANK_MOVE_PAIN1),
        MOVE_PAIN2 => Some(&SUPERTANK_MOVE_PAIN2),
        MOVE_PAIN3 => Some(&SUPERTANK_MOVE_PAIN3),
        MOVE_DEATH => Some(&SUPERTANK_MOVE_DEATH),
        MOVE_BACKWARD => Some(&SUPERTANK_MOVE_BACKWARD),
        MOVE_ATTACK1 => Some(&SUPERTANK_MOVE_ATTACK1),
        MOVE_ATTACK2 => Some(&SUPERTANK_MOVE_ATTACK2),
        MOVE_ATTACK3 => Some(&SUPERTANK_MOVE_ATTACK3),
        MOVE_ATTACK4 => Some(&SUPERTANK_MOVE_ATTACK4),
        MOVE_END_ATTACK1 => Some(&SUPERTANK_MOVE_END_ATTACK1),
        _ => None,
    }
}
