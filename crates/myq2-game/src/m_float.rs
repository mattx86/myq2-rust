// m_float.rs — Floater monster
// Converted from: myq2-original/game/m_float.c
// Frame definitions from: myq2-original/game/m_float.h

use crate::g_local::*;
use crate::game::*;
use crate::g_utils::g_free_edict;
use crate::entity_adapters::{gi_soundindex, gi_modelindex, g_project_source, monster_flash_offset};
use myq2_common::common::{frand as random, rand_i32};
use myq2_common::q_shared::vector_set;

// ============================================================
// Frame definitions (from m_float.h)
// This file generated by ModelGen - Do NOT Modify
// ============================================================

pub const FRAME_ACTVAT01: i32 = 0;
pub const FRAME_ACTVAT02: i32 = 1;
pub const FRAME_ACTVAT03: i32 = 2;
pub const FRAME_ACTVAT04: i32 = 3;
pub const FRAME_ACTVAT05: i32 = 4;
pub const FRAME_ACTVAT06: i32 = 5;
pub const FRAME_ACTVAT07: i32 = 6;
pub const FRAME_ACTVAT08: i32 = 7;
pub const FRAME_ACTVAT09: i32 = 8;
pub const FRAME_ACTVAT10: i32 = 9;
pub const FRAME_ACTVAT11: i32 = 10;
pub const FRAME_ACTVAT12: i32 = 11;
pub const FRAME_ACTVAT13: i32 = 12;
pub const FRAME_ACTVAT14: i32 = 13;
pub const FRAME_ACTVAT15: i32 = 14;
pub const FRAME_ACTVAT16: i32 = 15;
pub const FRAME_ACTVAT17: i32 = 16;
pub const FRAME_ACTVAT18: i32 = 17;
pub const FRAME_ACTVAT19: i32 = 18;
pub const FRAME_ACTVAT20: i32 = 19;
pub const FRAME_ACTVAT21: i32 = 20;
pub const FRAME_ACTVAT22: i32 = 21;
pub const FRAME_ACTVAT23: i32 = 22;
pub const FRAME_ACTVAT24: i32 = 23;
pub const FRAME_ACTVAT25: i32 = 24;
pub const FRAME_ACTVAT26: i32 = 25;
pub const FRAME_ACTVAT27: i32 = 26;
pub const FRAME_ACTVAT28: i32 = 27;
pub const FRAME_ACTVAT29: i32 = 28;
pub const FRAME_ACTVAT30: i32 = 29;
pub const FRAME_ACTVAT31: i32 = 30;
pub const FRAME_ATTAK101: i32 = 31;
pub const FRAME_ATTAK102: i32 = 32;
pub const FRAME_ATTAK103: i32 = 33;
pub const FRAME_ATTAK104: i32 = 34;
pub const FRAME_ATTAK105: i32 = 35;
pub const FRAME_ATTAK106: i32 = 36;
pub const FRAME_ATTAK107: i32 = 37;
pub const FRAME_ATTAK108: i32 = 38;
pub const FRAME_ATTAK109: i32 = 39;
pub const FRAME_ATTAK110: i32 = 40;
pub const FRAME_ATTAK111: i32 = 41;
pub const FRAME_ATTAK112: i32 = 42;
pub const FRAME_ATTAK113: i32 = 43;
pub const FRAME_ATTAK114: i32 = 44;
pub const FRAME_ATTAK201: i32 = 45;
pub const FRAME_ATTAK202: i32 = 46;
pub const FRAME_ATTAK203: i32 = 47;
pub const FRAME_ATTAK204: i32 = 48;
pub const FRAME_ATTAK205: i32 = 49;
pub const FRAME_ATTAK206: i32 = 50;
pub const FRAME_ATTAK207: i32 = 51;
pub const FRAME_ATTAK208: i32 = 52;
pub const FRAME_ATTAK209: i32 = 53;
pub const FRAME_ATTAK210: i32 = 54;
pub const FRAME_ATTAK211: i32 = 55;
pub const FRAME_ATTAK212: i32 = 56;
pub const FRAME_ATTAK213: i32 = 57;
pub const FRAME_ATTAK214: i32 = 58;
pub const FRAME_ATTAK215: i32 = 59;
pub const FRAME_ATTAK216: i32 = 60;
pub const FRAME_ATTAK217: i32 = 61;
pub const FRAME_ATTAK218: i32 = 62;
pub const FRAME_ATTAK219: i32 = 63;
pub const FRAME_ATTAK220: i32 = 64;
pub const FRAME_ATTAK221: i32 = 65;
pub const FRAME_ATTAK222: i32 = 66;
pub const FRAME_ATTAK223: i32 = 67;
pub const FRAME_ATTAK224: i32 = 68;
pub const FRAME_ATTAK225: i32 = 69;
pub const FRAME_ATTAK301: i32 = 70;
pub const FRAME_ATTAK302: i32 = 71;
pub const FRAME_ATTAK303: i32 = 72;
pub const FRAME_ATTAK304: i32 = 73;
pub const FRAME_ATTAK305: i32 = 74;
pub const FRAME_ATTAK306: i32 = 75;
pub const FRAME_ATTAK307: i32 = 76;
pub const FRAME_ATTAK308: i32 = 77;
pub const FRAME_ATTAK309: i32 = 78;
pub const FRAME_ATTAK310: i32 = 79;
pub const FRAME_ATTAK311: i32 = 80;
pub const FRAME_ATTAK312: i32 = 81;
pub const FRAME_ATTAK313: i32 = 82;
pub const FRAME_ATTAK314: i32 = 83;
pub const FRAME_ATTAK315: i32 = 84;
pub const FRAME_ATTAK316: i32 = 85;
pub const FRAME_ATTAK317: i32 = 86;
pub const FRAME_ATTAK318: i32 = 87;
pub const FRAME_ATTAK319: i32 = 88;
pub const FRAME_ATTAK320: i32 = 89;
pub const FRAME_ATTAK321: i32 = 90;
pub const FRAME_ATTAK322: i32 = 91;
pub const FRAME_ATTAK323: i32 = 92;
pub const FRAME_ATTAK324: i32 = 93;
pub const FRAME_ATTAK325: i32 = 94;
pub const FRAME_ATTAK326: i32 = 95;
pub const FRAME_ATTAK327: i32 = 96;
pub const FRAME_ATTAK328: i32 = 97;
pub const FRAME_ATTAK329: i32 = 98;
pub const FRAME_ATTAK330: i32 = 99;
pub const FRAME_ATTAK331: i32 = 100;
pub const FRAME_ATTAK332: i32 = 101;
pub const FRAME_ATTAK333: i32 = 102;
pub const FRAME_ATTAK334: i32 = 103;
pub const FRAME_DEATH01: i32 = 104;
pub const FRAME_DEATH02: i32 = 105;
pub const FRAME_DEATH03: i32 = 106;
pub const FRAME_DEATH04: i32 = 107;
pub const FRAME_DEATH05: i32 = 108;
pub const FRAME_DEATH06: i32 = 109;
pub const FRAME_DEATH07: i32 = 110;
pub const FRAME_DEATH08: i32 = 111;
pub const FRAME_DEATH09: i32 = 112;
pub const FRAME_DEATH10: i32 = 113;
pub const FRAME_DEATH11: i32 = 114;
pub const FRAME_DEATH12: i32 = 115;
pub const FRAME_DEATH13: i32 = 116;
pub const FRAME_PAIN101: i32 = 117;
pub const FRAME_PAIN102: i32 = 118;
pub const FRAME_PAIN103: i32 = 119;
pub const FRAME_PAIN104: i32 = 120;
pub const FRAME_PAIN105: i32 = 121;
pub const FRAME_PAIN106: i32 = 122;
pub const FRAME_PAIN107: i32 = 123;
pub const FRAME_PAIN201: i32 = 124;
pub const FRAME_PAIN202: i32 = 125;
pub const FRAME_PAIN203: i32 = 126;
pub const FRAME_PAIN204: i32 = 127;
pub const FRAME_PAIN205: i32 = 128;
pub const FRAME_PAIN206: i32 = 129;
pub const FRAME_PAIN207: i32 = 130;
pub const FRAME_PAIN208: i32 = 131;
pub const FRAME_PAIN301: i32 = 132;
pub const FRAME_PAIN302: i32 = 133;
pub const FRAME_PAIN303: i32 = 134;
pub const FRAME_PAIN304: i32 = 135;
pub const FRAME_PAIN305: i32 = 136;
pub const FRAME_PAIN306: i32 = 137;
pub const FRAME_PAIN307: i32 = 138;
pub const FRAME_PAIN308: i32 = 139;
pub const FRAME_PAIN309: i32 = 140;
pub const FRAME_PAIN310: i32 = 141;
pub const FRAME_PAIN311: i32 = 142;
pub const FRAME_PAIN312: i32 = 143;
pub const FRAME_STAND101: i32 = 144;
pub const FRAME_STAND102: i32 = 145;
pub const FRAME_STAND103: i32 = 146;
pub const FRAME_STAND104: i32 = 147;
pub const FRAME_STAND105: i32 = 148;
pub const FRAME_STAND106: i32 = 149;
pub const FRAME_STAND107: i32 = 150;
pub const FRAME_STAND108: i32 = 151;
pub const FRAME_STAND109: i32 = 152;
pub const FRAME_STAND110: i32 = 153;
pub const FRAME_STAND111: i32 = 154;
pub const FRAME_STAND112: i32 = 155;
pub const FRAME_STAND113: i32 = 156;
pub const FRAME_STAND114: i32 = 157;
pub const FRAME_STAND115: i32 = 158;
pub const FRAME_STAND116: i32 = 159;
pub const FRAME_STAND117: i32 = 160;
pub const FRAME_STAND118: i32 = 161;
pub const FRAME_STAND119: i32 = 162;
pub const FRAME_STAND120: i32 = 163;
pub const FRAME_STAND121: i32 = 164;
pub const FRAME_STAND122: i32 = 165;
pub const FRAME_STAND123: i32 = 166;
pub const FRAME_STAND124: i32 = 167;
pub const FRAME_STAND125: i32 = 168;
pub const FRAME_STAND126: i32 = 169;
pub const FRAME_STAND127: i32 = 170;
pub const FRAME_STAND128: i32 = 171;
pub const FRAME_STAND129: i32 = 172;
pub const FRAME_STAND130: i32 = 173;
pub const FRAME_STAND131: i32 = 174;
pub const FRAME_STAND132: i32 = 175;
pub const FRAME_STAND133: i32 = 176;
pub const FRAME_STAND134: i32 = 177;
pub const FRAME_STAND135: i32 = 178;
pub const FRAME_STAND136: i32 = 179;
pub const FRAME_STAND137: i32 = 180;
pub const FRAME_STAND138: i32 = 181;
pub const FRAME_STAND139: i32 = 182;
pub const FRAME_STAND140: i32 = 183;
pub const FRAME_STAND141: i32 = 184;
pub const FRAME_STAND142: i32 = 185;
pub const FRAME_STAND143: i32 = 186;
pub const FRAME_STAND144: i32 = 187;
pub const FRAME_STAND145: i32 = 188;
pub const FRAME_STAND146: i32 = 189;
pub const FRAME_STAND147: i32 = 190;
pub const FRAME_STAND148: i32 = 191;
pub const FRAME_STAND149: i32 = 192;
pub const FRAME_STAND150: i32 = 193;
pub const FRAME_STAND151: i32 = 194;
pub const FRAME_STAND152: i32 = 195;
pub const FRAME_STAND201: i32 = 196;
pub const FRAME_STAND202: i32 = 197;
pub const FRAME_STAND203: i32 = 198;
pub const FRAME_STAND204: i32 = 199;
pub const FRAME_STAND205: i32 = 200;
pub const FRAME_STAND206: i32 = 201;
pub const FRAME_STAND207: i32 = 202;
pub const FRAME_STAND208: i32 = 203;
pub const FRAME_STAND209: i32 = 204;
pub const FRAME_STAND210: i32 = 205;
pub const FRAME_STAND211: i32 = 206;
pub const FRAME_STAND212: i32 = 207;
pub const FRAME_STAND213: i32 = 208;
pub const FRAME_STAND214: i32 = 209;
pub const FRAME_STAND215: i32 = 210;
pub const FRAME_STAND216: i32 = 211;
pub const FRAME_STAND217: i32 = 212;
pub const FRAME_STAND218: i32 = 213;
pub const FRAME_STAND219: i32 = 214;
pub const FRAME_STAND220: i32 = 215;
pub const FRAME_STAND221: i32 = 216;
pub const FRAME_STAND222: i32 = 217;
pub const FRAME_STAND223: i32 = 218;
pub const FRAME_STAND224: i32 = 219;
pub const FRAME_STAND225: i32 = 220;
pub const FRAME_STAND226: i32 = 221;
pub const FRAME_STAND227: i32 = 222;
pub const FRAME_STAND228: i32 = 223;
pub const FRAME_STAND229: i32 = 224;
pub const FRAME_STAND230: i32 = 225;
pub const FRAME_STAND231: i32 = 226;
pub const FRAME_STAND232: i32 = 227;
pub const FRAME_STAND233: i32 = 228;
pub const FRAME_STAND234: i32 = 229;
pub const FRAME_STAND235: i32 = 230;
pub const FRAME_STAND236: i32 = 231;
pub const FRAME_STAND237: i32 = 232;
pub const FRAME_STAND238: i32 = 233;
pub const FRAME_STAND239: i32 = 234;
pub const FRAME_STAND240: i32 = 235;
pub const FRAME_STAND241: i32 = 236;
pub const FRAME_STAND242: i32 = 237;
pub const FRAME_STAND243: i32 = 238;
pub const FRAME_STAND244: i32 = 239;
pub const FRAME_STAND245: i32 = 240;
pub const FRAME_STAND246: i32 = 241;
pub const FRAME_STAND247: i32 = 242;
pub const FRAME_STAND248: i32 = 243;
pub const FRAME_STAND249: i32 = 244;
pub const FRAME_STAND250: i32 = 245;
pub const FRAME_STAND251: i32 = 246;
pub const FRAME_STAND252: i32 = 247;

pub const MODEL_SCALE: f32 = 1.0;

// ============================================================
// Sound channel / attenuation constants (mirrors C defines)
// ============================================================

// CHAN_*, ATTN_*, EF_* come from g_local::* re-export (myq2_common::q_shared)

use crate::g_local::TE_SPLASH;
// MULTICAST_PVS comes from g_local::*

// Muzzle flash
const MZ2_FLOAT_BLASTER_1: i32 = 82;

// ============================================================

use crate::ai_wrappers::{ai_stand, ai_walk, ai_run, ai_charge, ai_move};

// ============================================================
// Sound indices (module-level state, replaces C statics)
// ============================================================

#[derive(Default)]
pub struct FloaterSounds {
    pub attack2: i32,
    pub attack3: i32,
    pub death1: i32,
    pub idle: i32,
    pub pain1: i32,
    pub pain2: i32,
    pub sight: i32,
}

static SOUNDS: std::sync::OnceLock<FloaterSounds> = std::sync::OnceLock::new();

use crate::game_import::{
    gi_sound, gi_linkentity, gi_write_byte, gi_write_position, gi_write_dir, gi_multicast,
};

fn fire_hit(ctx: &mut GameContext, self_idx: i32, aim: [f32; 3], damage: i32, kick: i32) {
    crate::g_weapon::fire_hit(self_idx as usize, &mut ctx.edicts, &mut ctx.level, &aim, damage, kick);
}



fn flymonster_start(ctx: &mut GameContext, self_idx: i32) {
    crate::g_monster::flymonster_start(ctx, self_idx);
}



use myq2_common::q_shared::{
    angle_vectors, vector_subtract_to as vector_subtract,
    vector_copy_to as vector_copy,
};



static VEC3_ORIGIN: [f32; 3] = [0.0, 0.0, 0.0];

// ============================================================
// Move table indices (monsterinfo.currentmove references)
// ============================================================

pub const MOVE_STAND1: usize = 0;
pub const MOVE_STAND2: usize = 1;
pub const MOVE_ACTIVATE: usize = 2;
pub const MOVE_ATTACK1: usize = 3;
pub const MOVE_ATTACK2: usize = 4;
pub const MOVE_ATTACK3: usize = 5;
pub const MOVE_DEATH: usize = 6;
pub const MOVE_PAIN1: usize = 7;
pub const MOVE_PAIN2: usize = 8;
pub const MOVE_PAIN3: usize = 9;
pub const MOVE_WALK: usize = 10;
pub const MOVE_RUN: usize = 11;

// ============================================================
// Floater behavior functions
// ============================================================

pub fn floater_sight(_ctx: &mut GameContext, self_idx: i32, _other_idx: i32) {
    let sound_sight = SOUNDS.get().map_or(0, |s| s.sight);
    gi_sound(self_idx, CHAN_VOICE, sound_sight, 1.0, ATTN_NORM, 0.0);
}

pub fn floater_idle(_ctx: &mut GameContext, self_idx: i32) {
    let sound_idle = SOUNDS.get().map_or(0, |s| s.idle);
    gi_sound(self_idx, CHAN_VOICE, sound_idle, 1.0, ATTN_IDLE, 0.0);
}

pub fn floater_fire_blaster(self_ent: &mut Edict, ctx: &mut GameContext) {
    let mut start = [0.0_f32; 3];
    let mut forward = [0.0_f32; 3];
    let mut right = [0.0_f32; 3];
    let mut end = [0.0_f32; 3];
    let mut dir = [0.0_f32; 3];

    let effect: u32 = if self_ent.s.frame == FRAME_ATTAK104 || self_ent.s.frame == FRAME_ATTAK107 {
        EF_HYPERBLASTER
    } else {
        0
    };

    angle_vectors(&self_ent.s.angles, Some(&mut forward), Some(&mut right), None);
    let offset = monster_flash_offset(MZ2_FLOAT_BLASTER_1);
    g_project_source(&self_ent.s.origin, &offset, &forward, &right, &mut start);

    // Get enemy origin + viewheight
    let enemy_idx = self_ent.enemy;
    if enemy_idx >= 0 && (enemy_idx as usize) < ctx.edicts.len() {
        let enemy = &ctx.edicts[enemy_idx as usize];
        vector_copy(&enemy.s.origin, &mut end);
        end[2] += enemy.viewheight as f32;
    }
    vector_subtract(&end, &start, &mut dir);

    let self_idx = self_ent.s.number;
    crate::g_monster::monster_fire_blaster(ctx, self_idx, start, dir, 1, 1000, MZ2_FLOAT_BLASTER_1, effect as i32);
}

// ============================================================
// Stand animation 1
// ============================================================

static FLOATER_FRAMES_STAND1: [MFrame; 52] = [
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_STAND1: MMove = MMove {
    firstframe: FRAME_STAND101,
    lastframe: FRAME_STAND152,
    frames: &FLOATER_FRAMES_STAND1,
    endfunc: None,
};

// ============================================================
// Stand animation 2
// ============================================================

static FLOATER_FRAMES_STAND2: [MFrame; 52] = [
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_stand, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_STAND2: MMove = MMove {
    firstframe: FRAME_STAND201,
    lastframe: FRAME_STAND252,
    frames: &FLOATER_FRAMES_STAND2,
    endfunc: None,
};

pub fn floater_stand(self_ent: &mut Edict, _ctx: &mut GameContext) {
    if random() <= 0.5 {
        self_ent.monsterinfo.currentmove = Some(MOVE_STAND1);
    } else {
        self_ent.monsterinfo.currentmove = Some(MOVE_STAND2);
    }
}

// ============================================================
// Activate animation
// ============================================================

static FLOATER_FRAMES_ACTIVATE: [MFrame; 30] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_ACTIVATE: MMove = MMove {
    firstframe: FRAME_ACTVAT01,
    lastframe: FRAME_ACTVAT31,
    frames: &FLOATER_FRAMES_ACTIVATE,
    endfunc: None,
};

// ============================================================
// Attack 1 — Blaster
// ============================================================

static FLOATER_FRAMES_ATTACK1: [MFrame; 14] = [
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },                               // Blaster attack
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },          // BOOM -- LOOP Starts
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_fire_blaster) },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },                               // -- LOOP Ends
];

pub static FLOATER_MOVE_ATTACK1: MMove = MMove {
    firstframe: FRAME_ATTAK101,
    lastframe: FRAME_ATTAK114,
    frames: &FLOATER_FRAMES_ATTACK1,
    endfunc: Some(floater_run),
};

// ============================================================
// Attack 2 — Claws (wham)
// ============================================================

static FLOATER_FRAMES_ATTACK2: [MFrame; 25] = [
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },                               // Claws
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_wham) },                 // WHAM -- LOOP Starts
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },                               // -- LOOP Ends
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_ATTACK2: MMove = MMove {
    firstframe: FRAME_ATTAK201,
    lastframe: FRAME_ATTAK225,
    frames: &FLOATER_FRAMES_ATTACK2,
    endfunc: Some(floater_run),
};

// ============================================================
// Attack 3 — Zap
// ============================================================

static FLOATER_FRAMES_ATTACK3: [MFrame; 34] = [
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: Some(floater_zap) },                  // -- LOOP Starts
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },                               // -- LOOP Ends
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_charge, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_ATTACK3: MMove = MMove {
    firstframe: FRAME_ATTAK301,
    lastframe: FRAME_ATTAK334,
    frames: &FLOATER_FRAMES_ATTACK3,
    endfunc: Some(floater_run),
};

// ============================================================
// Death animation
// ============================================================

static FLOATER_FRAMES_DEATH: [MFrame; 13] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_DEATH: MMove = MMove {
    firstframe: FRAME_DEATH01,
    lastframe: FRAME_DEATH13,
    frames: &FLOATER_FRAMES_DEATH,
    endfunc: Some(floater_dead),
};

// ============================================================
// Pain animations
// ============================================================

static FLOATER_FRAMES_PAIN1: [MFrame; 7] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_PAIN1: MMove = MMove {
    firstframe: FRAME_PAIN101,
    lastframe: FRAME_PAIN107,
    frames: &FLOATER_FRAMES_PAIN1,
    endfunc: Some(floater_run),
};

static FLOATER_FRAMES_PAIN2: [MFrame; 8] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_PAIN2: MMove = MMove {
    firstframe: FRAME_PAIN201,
    lastframe: FRAME_PAIN208,
    frames: &FLOATER_FRAMES_PAIN2,
    endfunc: Some(floater_run),
};

static FLOATER_FRAMES_PAIN3: [MFrame; 12] = [
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
    MFrame { ai_fn: ai_move, dist: 0.0, think_fn: None },
];

pub static FLOATER_MOVE_PAIN3: MMove = MMove {
    firstframe: FRAME_PAIN301,
    lastframe: FRAME_PAIN312,
    frames: &FLOATER_FRAMES_PAIN3,
    endfunc: Some(floater_run),
};

// ============================================================
// Walk animation
// ============================================================

static FLOATER_FRAMES_WALK: [MFrame; 52] = [
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
    MFrame { ai_fn: ai_walk, dist: 5.0, think_fn: None },
];

pub static FLOATER_MOVE_WALK: MMove = MMove {
    firstframe: FRAME_STAND101,
    lastframe: FRAME_STAND152,
    frames: &FLOATER_FRAMES_WALK,
    endfunc: None,
};

// ============================================================
// Run animation
// ============================================================

static FLOATER_FRAMES_RUN: [MFrame; 52] = [
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
    MFrame { ai_fn: ai_run, dist: 13.0, think_fn: None },
];

pub static FLOATER_MOVE_RUN: MMove = MMove {
    firstframe: FRAME_STAND101,
    lastframe: FRAME_STAND152,
    frames: &FLOATER_FRAMES_RUN,
    endfunc: None,
};

// ============================================================
// Behavior functions
// ============================================================

pub fn floater_run(self_ent: &mut Edict, _ctx: &mut GameContext) {
    if self_ent.monsterinfo.aiflags.intersects(AI_STAND_GROUND) {
        self_ent.monsterinfo.currentmove = Some(MOVE_STAND1);
    } else {
        self_ent.monsterinfo.currentmove = Some(MOVE_RUN);
    }
}

pub fn floater_walk(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.monsterinfo.currentmove = Some(MOVE_WALK);
}

pub fn floater_wham(self_ent: &mut Edict, ctx: &mut GameContext) {
    let aim: [f32; 3] = [MELEE_DISTANCE, 0.0, 0.0];
    let sound_attack3 = SOUNDS.get().map_or(0, |s| s.attack3);
    gi_sound(self_ent.s.number, CHAN_WEAPON, sound_attack3, 1.0, ATTN_NORM, 0.0);
    // fire_hit(self, aim, 5 + rand() % 6, -50)
    let damage = 5 + (rand_i32().unsigned_abs() % 6) as i32;
    fire_hit(ctx, self_ent.s.number, aim, damage, -50);
}

pub fn floater_zap(self_ent: &mut Edict, ctx: &mut GameContext) {
    let mut forward = [0.0_f32; 3];
    let mut right = [0.0_f32; 3];
    let mut origin = [0.0_f32; 3];
    let mut dir = [0.0_f32; 3];

    let enemy_idx = self_ent.enemy;
    if enemy_idx >= 0 && (enemy_idx as usize) < ctx.edicts.len() {
        let enemy_origin = ctx.edicts[enemy_idx as usize].s.origin;
        vector_subtract(&enemy_origin, &self_ent.s.origin, &mut dir);
    }

    angle_vectors(&self_ent.s.angles, Some(&mut forward), Some(&mut right), None);
    // Project attack origin (uses splash effect instead of muzzle flash)
    let offset: [f32; 3] = [18.5, -0.9, 10.0];
    g_project_source(&self_ent.s.origin, &offset, &forward, &right, &mut origin);

    let sound_attack2 = SOUNDS.get().map_or(0, |s| s.attack2);
    gi_sound(self_ent.s.number, CHAN_WEAPON, sound_attack2, 1.0, ATTN_NORM, 0.0);

    // Send splash effect for attack visual
    gi_write_byte(SVC_TEMP_ENTITY);
    gi_write_byte(TE_SPLASH);
    gi_write_byte(32);
    gi_write_position(&origin);
    gi_write_dir(&dir);
    gi_write_byte(1); // sparks
    gi_multicast(&origin, MULTICAST_PVS);

    let enemy_idx = self_ent.enemy;
    if enemy_idx >= 0 && (enemy_idx as usize) < ctx.edicts.len() {
        let enemy_origin = ctx.edicts[enemy_idx as usize].s.origin;
        let damage = 5 + (rand_i32().unsigned_abs() % 6) as i32;
        crate::g_combat::ctx_t_damage(
            ctx,
            enemy_idx as usize,
            self_ent.s.number as usize,
            self_ent.s.number as usize,
            &dir,
            &enemy_origin,
            &VEC3_ORIGIN,
            damage,
            -10,
            DAMAGE_ENERGY,
            MOD_UNKNOWN,
        );
    }
}

pub fn floater_attack(self_ent: &mut Edict, _ctx: &mut GameContext) {
    self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK1);
}

pub fn floater_melee(self_ent: &mut Edict, _ctx: &mut GameContext) {
    if random() < 0.5 {
        self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK3);
    } else {
        self_ent.monsterinfo.currentmove = Some(MOVE_ATTACK2);
    }
}

pub fn floater_pain(ctx: &mut GameContext, self_idx: i32, _other_idx: i32, _kick: f32, _damage: i32) {
    let self_ent = &mut ctx.edicts[self_idx as usize];

    if self_ent.health < (self_ent.max_health / 2) {
        self_ent.s.skinnum = 1;
    }

    if ctx.level.time < self_ent.pain_debounce_time {
        return;
    }

    self_ent.pain_debounce_time = ctx.level.time + 3.0;

    // skill->value == 3 means nightmare, no pain anims
    if ctx.skill >= 3.0 {
        return;
    }

    let n = ((rand_i32().wrapping_add(1)).unsigned_abs() % 3) as i32;
    if n == 0 {
        let sound_pain1 = SOUNDS.get().map_or(0, |s| s.pain1);
        gi_sound(self_idx, CHAN_VOICE, sound_pain1, 1.0, ATTN_NORM, 0.0);
        self_ent.monsterinfo.currentmove = Some(MOVE_PAIN1);
    } else {
        let sound_pain2 = SOUNDS.get().map_or(0, |s| s.pain2);
        gi_sound(self_idx, CHAN_VOICE, sound_pain2, 1.0, ATTN_NORM, 0.0);
        self_ent.monsterinfo.currentmove = Some(MOVE_PAIN2);
    }
}

pub fn floater_dead(self_ent: &mut Edict, _ctx: &mut GameContext) {
    vector_set(&mut self_ent.mins, -16.0, -16.0, -24.0);
    vector_set(&mut self_ent.maxs, 16.0, 16.0, -8.0);
    self_ent.movetype = MoveType::Toss;
    self_ent.svflags |= SVF_DEADMONSTER;
    self_ent.nextthink = 0.0;
    gi_linkentity(self_ent.s.number);
}

pub fn floater_die(ctx: &mut GameContext, self_idx: i32, _inflictor_idx: i32, _attacker_idx: i32, _damage: i32, _point: [f32; 3]) {
    let sound_death1 = SOUNDS.get().map_or(0, |s| s.death1);
    gi_sound(self_idx, CHAN_VOICE, sound_death1, 1.0, ATTN_NORM, 0.0);
    crate::g_misc::become_explosion1(ctx, self_idx as usize);
}

// ============================================================
// Spawn function
// ============================================================

/// QUAKED monster_floater (1 .5 0) (-16 -16 -24) (16 16 32) Ambush Trigger_Spawn Sight
pub fn sp_monster_floater(ctx: &mut GameContext, self_idx: i32) {
    if ctx.deathmatch != 0.0 {
        g_free_edict(ctx, self_idx as usize);
        return;
    }

    SOUNDS.get_or_init(|| FloaterSounds {
        attack2: gi_soundindex("floater/fltatck2.wav"),
        attack3: gi_soundindex("floater/fltatck3.wav"),
        death1: gi_soundindex("floater/fltdeth1.wav"),
        idle: gi_soundindex("floater/fltidle1.wav"),
        pain1: gi_soundindex("floater/fltpain1.wav"),
        pain2: gi_soundindex("floater/fltpain2.wav"),
        sight: gi_soundindex("floater/fltsght1.wav"),
    });

    // Precache additional sounds
    gi_soundindex("floater/fltatck1.wav");

    {
        let self_ent = &mut ctx.edicts[self_idx as usize];
        self_ent.s.sound = gi_soundindex("floater/fltsrch1.wav");

        self_ent.movetype = MoveType::Step;
        self_ent.solid = Solid::Bbox;
        self_ent.s.modelindex = gi_modelindex("models/monsters/float/tris.md2");
        vector_set(&mut self_ent.mins, -24.0, -24.0, -24.0);
        vector_set(&mut self_ent.maxs, 24.0, 24.0, 32.0);

        self_ent.health = 200;
        self_ent.gib_health = -80;
        self_ent.mass = 300;

        // pain/die callbacks stored as dispatch indices
        // self_ent.pain_fn = Some(...);
        // self_ent.die_fn = Some(...);

        // monsterinfo callbacks stored as dispatch indices
        // self_ent.monsterinfo.stand_fn = Some(...);
        // self_ent.monsterinfo.walk_fn = Some(...);
        // self_ent.monsterinfo.run_fn = Some(...);
        // self_ent.monsterinfo.attack_fn = Some(...);
        // self_ent.monsterinfo.melee_fn = Some(...);
        // self_ent.monsterinfo.sight_fn = Some(...);
        // self_ent.monsterinfo.idle_fn = Some(...);

        gi_linkentity(self_idx);

        if random() <= 0.5 {
            self_ent.monsterinfo.currentmove = Some(MOVE_STAND1);
        } else {
            self_ent.monsterinfo.currentmove = Some(MOVE_STAND2);
        }

        self_ent.monsterinfo.scale = MODEL_SCALE;
    }

    flymonster_start(ctx, self_idx);
}
